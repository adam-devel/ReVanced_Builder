name: Check for updates

on:
  # tiggers manually
  workflow_dispatch:
  # triggers every 2 hours
  schedule:
    - cron: '0 0/2 * * *'

jobs:
  main:
    id: main
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Query revanced's API
        run: |
          mkdir -p build-tools
          endpoint=https://releases.rvcd.win/tools
          data=$(jq -r .tools <<< "$(curl -sL $endpoint)")
          jq <<< $data > build-tools/vanced-microg.json \
            '.[0]|{version, download_url:.browser_download_url}'
          jq <<< $data > build-tools/revanced-cli.json \
            '.[1]|{version, download_url:.browser_download_url}'
          jq <<< $data > build-tools/revanced-patches.json \
            '.[4]|{version, download_url:.browser_download_url}'
          jq <<< $data  > build-tools/revanced-integrations.json \
            '.[5]|{version, download_url:.browser_download_url}'

      - name: Compare
        id: compare
        run: echo ::set-output name=isModified::$([ -z "`git status --porcelain`" ] && echo "no" || echo "yes")

      - name: Commit the updates
        if: steps.compare.outputs.isModified == 'yes'
        uses: EndBug/add-and-commit@v9
        with:
          add: 'build-tools'
          message: automated update
          push: true
          
  build:
    if: jobs.main.steps.compare.outputs.isModified == 'yes'
    uses: ./.github/workflows/build.yml
        
